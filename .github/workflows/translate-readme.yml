name: Translate README (RU â†’ EN) + Link Check

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "README.md"

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Translate with LibreTranslate (free)
        run: |
          RESPONSE=$(curl -s -X POST "https://libretranslate.de/translate" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg text "$(cat README.md)" \
              '{q:$text, source:"ru", target:"en", format:"text"}')")

          echo "$RESPONSE" | jq -r '.translatedText' > README.en.md

      - name: Commit if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          if ! git diff --quiet README.en.md; then
            git add README.en.md
            git commit -m "Auto-translate README to English"
            git push
          else
            echo "No changes detected"
          fi

  link-check:
    needs: translate
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check Markdown links
        uses: lycheeorg/lychee-action@v1
        with:
          args: --verbose --no-progress README.md README.en.md